name: Deploy to DokiDoki

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger DokiDoki Deployment
        run: |
          set -e  # Exit on error
          payload=$(jq -n \
            --arg container_name "malura" \
            --arg action "trigger-deployment" \
            --arg repo_full_name "${{ github.repository }}" \
            --arg repo_url "${{ github.event.repository.ssh_url }}" \
            --arg triggered_by "${{ github.actor }}" \
            --arg commit_hash "${{ github.sha }}" \
            --arg commit_message "${{ github.event.head_commit.message }}" \
            --arg branch "${{ github.ref_name }}" \
            '{
              container_name: $container_name,
              action: $action,
              repository: {
                full_name: $repo_full_name,
                url: $repo_url
              },
              metadata: {
                triggered_by: $triggered_by,
                commit_hash: $commit_hash,
                commit_message: $commit_message,
                branch: $branch
              }
            }')

          curl -f -X POST "https://dokidoki.malura.de/webhooks" \
            -H "Content-Type: application/json" \
            -H "X-Webhook-Secret: ${{ secrets.DOKIDOKI_WEBHOOK_SECRET }}" \
            -d "$payload" \
            || (echo "Deployment webhook failed!" && exit 1)