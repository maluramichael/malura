map_hash_bucket_size 256;

map $uri $redirected_url {
  default "none";
  include /var/www/malura/prod/redirects.map;
}

# Language detection based on Accept-Language header
# German (de) is the default language served from root level
# English (en) content is served from /en/ subdirectory
map $http_accept_language $lang {
  default de;
  ~*^en en;
  ~*^de de;
}

server {
  server_name www.malura.de malura.de;
  listen 80;
  return 301 https://$host$request_uri;
}

server {
  server_name www.malura.de malura.de;
  access_log /var/log/nginx/malura.de.access.log;
  error_log /var/log/nginx/malura.de.error.log;
  listen 443 ssl;
  listen [::]:443 ssl;

  if ($redirected_url != "none") {
    return 301 $redirected_url;
  }

  # Handle English content requests
  location ~ ^/en/(.*) {
    root /var/www/malura/prod;
    
    if ($request_uri ~ ^/en/(.*)\.html$) {
      return 301 /en/$1;
    }
    
    try_files /en/$1 /en/$1/index.html /en/404/index.html;
  }
  
  # Handle root requests - redirect to language-specific version based on Accept-Language
  location = / {
    root /var/www/malura/prod;
    
    # If English is preferred, redirect to /en/
    if ($lang = en) {
      try_files /en/index.html /index.html;
    }
    
    # Default to German (root level)
    try_files /index.html /404/index.html;
  }

  # Handle all other requests (German content at root level)
  location / {
    root /var/www/malura/prod;

    if ($request_uri ~ ^/(.*)\.html$) {
      return 301 /$1;
    }

    # For German content, try root level first, then fallback to English
    try_files $uri $uri/index.html /en$uri /en$uri/index.html /404/index.html;
  }

  location = /robots.txt {
    add_header Content-Type text/plain;
    return 200 "User-agent: *\nAllow: /\n";
  }

  location ~ ^/(\d\d\d\d/\d\d/\d\d)/(.*) {
    return 301 /blog/$1/$2;
  }

  location ~ ^/blog/\d\d\d\d/\d\d/\d\d/?$ {
    return 301 /blog;
  }

  location ~ ^/blog/\d\d\d\d/\d\d/?$ {
    return 301 /blog;
  }

  location ~ ^/blog/\d\d\d\d/?$ {
    return 301 /blog;
  }

  location ~ ^/blog/project/.+ {
    return 301 /projects;
  }

  location ~ ^/project/.+ {
    return 301 /projects;
  }

  ssl_certificate /etc/letsencrypt/live/malura.de/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/malura.de/privkey.pem;
  include /etc/letsencrypt/options-ssl-nginx.conf;
  include general.conf;
  ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}
